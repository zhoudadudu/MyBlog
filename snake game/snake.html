<title>Snake</title>

<style>
    body {
        justify-items: center;
    }

    a {
        display: flex;
        justify-content: center;
        font-size: 50px;
        text-decoration: none;
        color: blue;
    }
</style>

<h1>Snake</h1>
<canvas></canvas>

<a href="../index.html">返回首页</a>

<script>

    var blockSize = 25;
    var rows = 20;
    var cols = 20;
    var gameOver = false;

    const canvas = document.querySelector('canvas')
    const context = canvas.getContext('2d')

    canvas.width = cols * blockSize;
    canvas.height = rows * blockSize;

    class Snake {

        constructor({ position }) {
            this.position = position;
            this.velocity = {
                x: 0,
                y: 0
            }
        }

        draw() {
            context.fillStyle = "lime";
            //画蛇头
            context.fillRect(this.position.x, this.position.y, blockSize, blockSize);

            //画蛇身
            for (let i = 0; i < snakeBody.length; i++) {
                context.fillRect(snakeBody[i][0], snakeBody[i][1], blockSize, blockSize);
            }
        }

        update() {
            this.draw();

            //蛇撞墙
            if (this.position.x < 0 || this.position.x >= cols * blockSize || this.position.y < 0 || this.position.y >= rows * blockSize) {
                gameOver = true
                alert("Game Over")
            }

            //蛇移动
            this.position.x += this.velocity.x * blockSize
            this.position.y += this.velocity.y * blockSize

            //蛇撞自己
            if (snakeBody.length > 1) {
                for (let i = 1; i < snakeBody.length; i++) {
                    if (snake.position.x == snakeBody[i][0] && snake.position.y == snakeBody[i][1]) {
                        gameOver = true
                        alert("Game Over")
                        console.log("撞自己")
                    }
                }
            }

            //蛇吃食物
            if (this.position.x == food.position.x && this.position.y == food.position.y) {
                snakeBody.push([food.position.x, food.position.y])
                food.placeFood()
            }
            //更新蛇身位置
            for (let i = snakeBody.length - 1; i > 0; i--) {
                snakeBody[i] = snakeBody[i - 1];
            }
            //更新蛇头位置
            if (snakeBody.length) {
                snakeBody[0] = [this.position.x, this.position.y];
            }

        }
    }

    class Food {
        constructor({ position }) {
            this.position = position;
        }

        draw() {
            context.fillStyle = "red"
            context.fillRect(this.position.x, this.position.y, blockSize, blockSize)
        }

        placeFood() {
            this.position.x = Math.floor(Math.random() * cols) * blockSize
            this.position.y = Math.floor(Math.random() * rows) * blockSize
        }
    }

    addEventListener("keydown", (event) => {

        if (snakeBody.length == 1) {
            switch (event.key) {
                case 'w':
                    snake.velocity.x = 0;
                    snake.velocity.y = -1;
                    break

                case 's':
                    snake.velocity.x = 0;
                    snake.velocity.y = 1;
                    break

                case 'a':
                    snake.velocity.x = -1;
                    snake.velocity.y = 0;
                    break

                case 'd':
                    snake.velocity.x = 1;
                    snake.velocity.y = 0;
                    break
            }
        }

        if (snakeBody.length > 1) {
            switch (event.key) {
                case 'w':
                    if (snake.velocity.y != 1) {
                        snake.velocity.x = 0;
                        snake.velocity.y = -1;
                    }
                    break

                case 's':
                    if (snake.velocity.y != -1) {
                        snake.velocity.x = 0;
                        snake.velocity.y = 1;
                    }
                    break

                case 'a':
                    if (snake.velocity.x != 1) {
                        snake.velocity.x = -1;
                        snake.velocity.y = 0;
                    }
                    break

                case 'd':
                    if (snake.velocity.x != -1) {
                        snake.velocity.x = 1;
                        snake.velocity.y = 0;
                    }
                    break
            }
        }
    })
    //主循环
    function mainLoop() {

        if (gameOver) {
            return
        }
        context.fillStyle = "black"
        context.fillRect(0, 0, canvas.width, canvas.height)

        food.draw()

        snake.update()
    }

    //蛇位置初始化
    const snake = new Snake({
        position: {
            x: Math.floor(Math.random() * cols) * blockSize,
            y: Math.floor(Math.random() * rows) * blockSize
        }
    })

    //食物位置初始化
    const food = new Food({
        position: {
            x: Math.floor(Math.random() * cols) * blockSize,
            y: Math.floor(Math.random() * rows) * blockSize
        }
    })

    //蛇身初始化
    var snakeBody = [[snake.position.x, snake.position.y]]

    food.placeFood()

    setInterval(mainLoop, 100);

</script>